# PDF Malware Detection Microservice

## Requirements
- **Python**: 3.8 or higher
- **Dependencies**:
  ```bash
  pip install flask PyPDF2 pandas numpy scikit-learn joblib
  ```
- **Dataset**: `PDFMalware2022.csv` (for training)
- **Files**: `pdf_malware_model.pkl`, `scaler.pkl` (generated by `train_model.py`)

## Setup

1. **Clone or Set Up the Project**:
   - Place `train_model.py` and `app.py` in your project directory (e.g., `/home/nohrer/pdf-malware-detection`).
   - Ensure `PDFMalware2022.csv` is in the same directory for training.

2. **Activate Virtual Environment** (optional but recommended):
   ```bash
   source /home/nohrer/Desktop/Django/venv-django/bin/activate
   ```

3. **Install Dependencies**:
   ```bash
   pip install flask PyPDF2 pandas numpy scikit-learn joblib
   ```

4. **Train the Model**:
   - Run the training script to generate the model and scaler:
     ```bash
     python train_model.py
     ```
   - Outputs: `pdf_malware_model.pkl`, `scaler.pkl`

5. **Run the Microservice**:
   - Start the Flask server:
     ```bash
     python app.py
     ```
   - The API runs at `http://localhost:8500/scan_pdf`.

## Usage

### API Endpoint
- **Endpoint**: `POST /scan_pdf`
- **Input**: PDF file (multipart/form-data, key: `file`)
- **Output**: JSON response (`{"result": "Malicious"}` or `{"result": "Benign"}`)

#### Example with `curl`:
```bash
curl -X POST -F "file=@/home/nohrer/Desktop/Devoir\ -\ CryptoGraphy.pdf" http://localhost:8500/scan_pdf
```

#### Example Response:
```json
{"result": "Benign"}
```

### Frontend Integration
Integrate with a web app (e.g., HTML form):
```html
<form action="http://localhost:8500/scan_pdf" method="POST" enctype="multipart/form-data">
    <input type="file" name="file" accept=".pdf">
    <button type="submit">Scan PDF</button>
</form>
```

## Files
- **train_model.py**: Trains a Logistic Regression model on `PDFMalware2022.csv`, saves `pdf_malware_model.pkl` and `scaler.pkl`.
- **app.py**: Flask microservice that extracts features from PDFs using `PyPDF2`, preprocesses them, and predicts malware using the trained model.
- **pdf_malware_model.pkl**: Saved Logistic Regression model.
- **scaler.pkl**: Saved StandardScaler for feature scaling.

## Notes
- **Feature Extraction**: Uses `PyPDF2` to extract basic features (e.g., `pdfsize`, `pages`, `isEncrypted`). Advanced features (e.g., `obj`, `Javascript`) are approximated, which may reduce accuracy. For better feature extraction, install `pdfid`:
  ```bash
  pip install git+https://github.com/didierstevens/pdf-tools
  ```
- **Security**: Temporary files are deleted after processing. Add file size limits and authentication for production.
- **Troubleshooting**:
  - **Connection Errors**: Ensure the server runs (`ps aux | grep python`) and port 8500 is free (`lsof -i :8500`).
  - **Missing Model Files**: Rerun `train_model.py` if `pdf_malware_model.pkl` or `scaler.pkl` are missing.
  - **PDF Parsing Errors**: If `{"error": "Failed to extract PDF features"}` occurs, ensure the PDF is valid and not password-protected.

## Maintenance
- **Update Model**: Rerun `train_model.py` with an updated `PDFMalware2022.csv` to refresh the model.
- **Logs**: Check Flask logs in the terminal running `app.py` for errors.
- **Dependencies**: Keep packages updated:
  ```bash
  pip install --upgrade flask PyPDF2 pandas numpy scikit-learn joblib
  ```